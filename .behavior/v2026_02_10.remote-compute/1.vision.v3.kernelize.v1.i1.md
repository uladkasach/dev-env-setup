# khlone: atomic concepts

> kernelized from 1.vision.v3.md

---

## atomic concepts

| concept | definition |
|---------|------------|
| **khlone** | clone zone orchestrator — manages zones, each with crews of clones |
| **brain** | ai provider (claude, codex, etc) — raw reason capability |
| **role** | identity with skills + briefs (foreman, mechanic, architect, etc) — defines capabilities |
| **clone** | brain + role via rhachet = actor ready to work (e.g., claude + mechanic = mechanic.1) |
| **crew** | set of clones on a zone; configured via `khlone.yml` |
| **clone.0** | the initial clone spawned on `khlone init`; configurable per crew |
| **zone** | remote machine + worktree + crew of clones |
| **orchestrator** | manages zone registry, instance lifecycle, secrets, cost; local (~/.khlone) or cloud |
| **khlone.yml** | zone config; specifies instance (type, region), supplies, and crew (clone.0, defaults) |
| **zone-provision** | findsert zone via declastruct-aws: provision instance, install supplies, init worktree |
| **dispatch** | send task to clone.0 (default) or specific clone (override) |
| **attach** | drop into a clone's raw stream |
| **detach** | return to filtered crew view |
| **sync** | push local changes to remote via git patch |
| **pull** | receive remote changes to local via git patch |
| **conflict** | divergent edits on same lines; explicit resolution required |
| **transcript** | full input/output stream per clone, archived locally |
| **tui** | local terminal interface; instant keystrokes, zero compute |
| **daemon** | remote service; spawns clones, routes by role, streams output |

---

## treestruct (general → specific)

```
khlone
├── orchestrator
│   ├── mode
│   │   ├── local (~/.khlone)
│   │   └── cloud (api gateway + lambda)
│   ├── zone.registry
│   ├── instance.lifecycle
│   │   ├── up
│   │   ├── down
│   │   └── ttl
│   ├── secrets.injection
│   └── cost.tracker
│       ├── compute ($/hr)
│       └── tokens (per clone)
│
├── zone
│   ├── config (khlone.yml)
│   │   ├── instance
│   │   │   ├── type (m6i.xlarge, t3.medium, etc)
│   │   │   ├── region (us-east-1, etc)
│   │   │   └── ami (base image)
│   │   ├── supplies (node, pnpm, aws cli, etc)
│   │   └── crew
│   │       ├── clone.0 (role + brain)
│   │       └── defaults (brain preferences, role limits)
│   │
│   ├── identity
│   │   ├── path (~/code/myproject-auth)
│   │   └── instance (ec2: m6i.4xlarge)
│   │
│   ├── provision (findsert via declastruct-aws)
│   │   ├── instance (findsert ec2)
│   │   ├── supplies (install node, pnpm, aws cli)
│   │   └── worktree
│   │       ├── git.clone (from origin or local push)
│   │       ├── git.checkout (branch, or create if dne)
│   │       └── deps.install (npm ci, etc)
│   │
│   ├── crew (spawned after provision)
│   │   ├── clone.0 (spawned on up; e.g., foreman.1, mechanic.1)
│   │   └── clone.N
│   │       ├── role (foreman, mechanic, architect, reviewer, tester, ergonomist)
│   │       ├── brain (claude, codex)
│   │       ├── number (auto-increment per role type)
│   │       ├── status (active, idle)
│   │       ├── progress (%)
│   │       └── task (current work)
│   │
│   ├── sync
│   │   ├── direction
│   │   │   ├── push (local → remote)
│   │   │   └── pull (remote → local)
│   │   ├── mechanism (git patch)
│   │   └── conflict
│   │       ├── detection (same lines edited)
│   │       └── resolution
│   │           ├── keep.local
│   │           ├── keep.remote
│   │           └── merge (manual)
│   │
│   └── transcript
│       ├── scope (per clone)
│       ├── content (input + output stream)
│       ├── storage (~/.khlone/logs/)
│       ├── search (across clones)
│       ├── export (to markdown)
│       └── cost (tokens per clone)
│
├── tui (local)
│   ├── dispatch
│   │   ├── target.default (clone.0)
│   │   └── target.override (--to clone.N)
│   ├── view
│   │   ├── crew (clones + status)
│   │   ├── zone (diffs, usage, cost)
│   │   └── log (transcripts)
│   ├── attach
│   │   ├── clone.N (raw stream)
│   │   └── shell (interactive)
│   ├── detach (filtered view)
│   ├── filter (eliminates fluff)
│   └── queue (offline changes)
│
└── daemon (remote)
    ├── spawn (clones)
    ├── route (by clone)
    ├── stream (per clone)
    ├── patch.sync
    └── resource.monitor
```

---

## relationships

```
human ──dispatch──► clone.0 ──hire──► crew
                        │
                        ├──► architect.1
                        ├──► mechanic.1
                        ├──► mechanic.2
                        └──► reviewer.1

human ──attach──► any clone.N (override)
human ──crew add──► clone.N (override)
human ──dispatch --to──► clone.N (override)

# clone.0 is configurable via khlone.yml
# e.g., ehmpathy crews use foreman.1 as clone.0
# e.g., solo devs might use mechanic.1 as clone.0
```

---

## data flow

```
LOCAL                           REMOTE
─────                           ──────
tui ◄──websocket──► daemon
 │                      │
 │                      ├──► clone.0 (e.g., foreman.1)
 │                      ├──► mechanic.1 (clone)
 │                      └──► mechanic.2 (clone)
 │                              │
 ▼                              ▼
worktree ◄──git patch──► worktree
 │
 ▼
~/.khlone/logs/ (transcripts)
```

---

## zone provision flow

```
khlone init
    │
    ▼
┌─────────────────────────┐
│ 1. read config          │ ← khlone.yml (instance, supplies, crew)
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────────────────────────┐
│ 2. zone.provision (via declastruct-aws) │
│   ├── provision instance (findsert ec2)     │
│   ├── provision supplies (node, pnpm, etc)  │
│   └── provision worktree                    │
│       ├── git clone (from origin)           │
│       ├── git checkout (branch)             │
│       └── deps install (npm ci)             │
└───────────┬─────────────────────────────────┘
            │
            ▼
┌─────────────────────────┐
│ 3. daemon.start         │ ← start khlone-daemon on remote
└───────────┬─────────────┘
            │
            ▼
┌─────────────────────────┐
│ 4. clone.0.spawn        │ ← spawn initial clone (from khlone.yml)
└───────────┬─────────────┘
            │
            ▼
        READY
```

### provision: fresh vs reconnect

**fresh zone** (instance dne):
1. zone.provision via declastruct-aws
   - findsert ec2 instance
   - install supplies (node, pnpm, aws cli)
   - git clone, checkout, npm ci
2. start daemon
3. spawn clone.0

**reconnect zone** (instance exists):
1. connect to ec2 instance
2. verify daemon is healthy (restart if needed)
3. sync patches from local (if any queued)
4. resume clone sessions

### provision: repo init strategies

| strategy | when | how |
|----------|------|-----|
| **origin clone** | repo exists on github | `git clone` with deploy key |
| **local push** | repo not on github yet | khlone pushes full repo as initial patch |
| **branch create** | branch dne remotely | `git checkout -b` on remote after clone |
| **branch checkout** | branch exists | `git checkout` + `git pull` |

---

## state transitions

```
zone: down → provision → ready → active → down
  provision: instance → supplies → worktree → daemon → clone.0
clone: spawned → active → idle → removed
sync: synced → diverged → conflict → resolved → synced
connection: connected → disconnected → reconnected
```

---

## invariants

1. one clone.0 per zone (spawned on `khlone init`; configured via `khlone.yml`)
2. clones auto-number per role type (mechanic.1, mechanic.2, ...)
3. dispatch without --to goes to clone.0
4. human can override clone.0 via --to or crew add
5. conflicts block until resolved (no silent overwrites)
6. transcripts archived per clone (you paid for those tokens)
7. orchestrator is always present (local or cloud, not optional)
8. zone provision is idempotent (findsert instance, findsert supplies, findsert worktree)
9. zone provision requires valid config in khlone.yml
10. worktree init requires repo access (origin deploy key or local push)
11. supplies are cached (skip if already installed)
