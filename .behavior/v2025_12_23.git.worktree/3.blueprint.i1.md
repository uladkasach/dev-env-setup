# Blueprint: Git Worktree Aliases

## Summary

Implement `git tree set|get|del` commands via bash aliases, replicating the [rhachet git.worktree.sh](https://github.com/ehmpathy/rhachet-roles-ehmpathy/blob/main/src/roles/mechanic/.skills/git.worktree.sh) pattern with a key modification: worktree directories include the repo name as a prefix.

## Current Behavior (rhachet)

```
_worktrees/
└── rhachet/
    └── vlad.new-feature/   # just branch name (sanitized)
```

## Target Behavior

```
_worktrees/
└── rhachet.vlad.new-feature/   # reponame.branchname (flat structure)
```

This enables working across multiple repos' worktrees in a single `_worktrees/` directory without namespace collisions.

---

## Implementation Plan

### 1. Add bash functions to `src/bash_aliases.sh`

Following the existing `git_alias_release` pattern:

```sh
######################
## git worktree helpers (invoked by git alias.tree)
##
## what: manage git worktrees with repo-prefixed directory names
##
## why: enables parallel work on branches without stashing/switching
##      repo prefix prevents collisions when working across multiple repos
##
## how:
##   git tree get           # list worktrees for current repo
##   git tree set <branch>  # create/find worktree for branch
##   git tree del <branch>  # remove worktree for branch
##
## worktree location: @gitroot/../_worktrees/$reponame.$branch/
######################
```

#### 1a. Helper functions

```sh
# .what: get the repo name from git root
_git_tree_repo_name() {
  basename "$(git rev-parse --show-toplevel 2>/dev/null || echo "$(pwd)" | sed 's|/_worktrees/.*||')"
}

# .what: sanitize branch name for filesystem (/ -> .)
_git_tree_sanitize_branch() {
  echo "$1" | tr '/' '.'
}

# .what: resolve the _worktrees directory path
_git_tree_worktrees_dir() {
  local git_root
  git_root="$(git rev-parse --show-toplevel 2>/dev/null)"
  # if inside a worktree, find the parent _worktrees dir
  if [[ "$git_root" == *"_worktrees"* ]]; then
    echo "${git_root%/*}"
  else
    echo "$(dirname "$git_root")/_worktrees"
  fi
}
```

#### 1b. Main dispatcher

```sh
git_alias_tree() {
  local cmd="${1:-get}"
  shift 2>/dev/null || true

  case "$cmd" in
    -h|--help)
      echo "git tree - manage worktrees with repo-prefixed directories"
      echo ""
      echo "usage: git tree <command> [options]"
      echo ""
      echo "commands:"
      echo "  get          list worktrees for current repo"
      echo "  set <branch> create or find worktree for branch"
      echo "  del <branch> remove worktree for branch"
      echo ""
      echo "run 'git tree <command> --help' for command-specific options"
      return 0
      ;;
    get) _git_tree_get "$@" ;;
    set) _git_tree_set "$@" ;;
    del) _git_tree_del "$@" ;;
    *)
      echo "usage: git tree <get|set|del> [branch]"
      echo "run 'git tree --help' for more info"
      return 1
      ;;
  esac
}
```

#### 1c. `git tree get` - list worktrees

```sh
_git_tree_get() {
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "git tree get - list worktrees for current repo"
    echo ""
    echo "usage: git tree get"
    echo ""
    echo "lists all worktrees matching the current repo name"
    return 0
  fi

  local worktrees_dir repo_name
  worktrees_dir="$(_git_tree_worktrees_dir)"
  repo_name="$(_git_tree_repo_name)"

  if [[ ! -d "$worktrees_dir" ]]; then
    echo "(no worktrees)"
    return 0
  fi

  local found=0
  echo "worktrees for $repo_name:"
  for dir in "$worktrees_dir"/"$repo_name".*; do
    [[ -d "$dir" ]] || continue
    found=1
    local name branch
    name="$(basename "$dir")"
    branch="${name#$repo_name.}"
    echo "  $branch => $dir"
  done

  [[ $found -eq 1 ]] || echo "  (none)"
}
```

#### 1d. `git tree set` - create/find worktree

```sh
_git_tree_set() {
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "git tree set - create or find worktree for branch"
    echo ""
    echo "usage: git tree set <branch> [options]"
    echo ""
    echo "options:"
    echo "  --main  create branch from origin/main instead of HEAD"
    echo "  --open  open worktree in codium after creation"
    echo ""
    echo "behavior:"
    echo "  - if worktree exists: keeps it (idempotent)"
    echo "  - if local branch exists: adds worktree to it"
    echo "  - if remote branch exists: tracks and adds worktree"
    echo "  - otherwise: creates new branch from HEAD (or origin/main with --main)"
    return 0
  fi

  local branch="$1"
  local open_flag=false main_flag=false

  # parse flags
  for arg in "$@"; do
    case "$arg" in
      --open) open_flag=true ;;
      --main) main_flag=true ;;
    esac
  done

  if [[ -z "$branch" || "$branch" == --* ]]; then
    echo "usage: git tree set <branch> [--open] [--main]"
    return 1
  fi

  local repo_name worktrees_dir sanitized worktree_path
  repo_name="$(_git_tree_repo_name)"
  worktrees_dir="$(_git_tree_worktrees_dir)"
  sanitized="$(_git_tree_sanitize_branch "$branch")"
  worktree_path="$worktrees_dir/$repo_name.$sanitized"

  # findsert: find or insert
  if [[ -d "$worktree_path" ]]; then
    echo "[KEEP] $worktree_path"
  else
    mkdir -p "$worktrees_dir"

    if [[ "$main_flag" == "true" ]]; then
      # create from origin/main (or origin/master)
      local base_ref="origin/main"
      git fetch origin main 2>/dev/null || base_ref="origin/master"
      git worktree add -b "$branch" "$worktree_path" "$base_ref"
    elif git show-ref --verify --quiet "refs/heads/$branch"; then
      # local branch exists
      git worktree add "$worktree_path" "$branch"
    elif git show-ref --verify --quiet "refs/remotes/origin/$branch"; then
      # remote branch exists
      git worktree add --track -b "$branch" "$worktree_path" "origin/$branch"
    else
      # create new branch from HEAD
      git worktree add -b "$branch" "$worktree_path"
    fi
    echo "[CREATE] $worktree_path"
  fi

  # optionally open in editor
  if [[ "$open_flag" == "true" ]]; then
    codium "$worktree_path" &
  fi
}
```

#### 1e. `git tree del` - remove worktree

```sh
_git_tree_del() {
  if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    echo "git tree del - remove worktree for branch"
    echo ""
    echo "usage: git tree del <branch>"
    echo ""
    echo "removes the worktree directory and prunes git references"
    echo "safe to run if worktree doesn't exist (no-op)"
    return 0
  fi

  local branch="$1"

  if [[ -z "$branch" ]]; then
    echo "usage: git tree del <branch>"
    return 1
  fi

  local repo_name worktrees_dir sanitized worktree_path
  repo_name="$(_git_tree_repo_name)"
  worktrees_dir="$(_git_tree_worktrees_dir)"
  sanitized="$(_git_tree_sanitize_branch "$branch")"
  worktree_path="$worktrees_dir/$repo_name.$sanitized"

  if [[ -d "$worktree_path" ]]; then
    git worktree remove "$worktree_path" --force 2>/dev/null || {
      rm -rf "$worktree_path"
      git worktree prune
    }
    echo "[DELETE] $repo_name.$sanitized"
  else
    echo "[SKIP] $repo_name.$sanitized (not found)"
  fi
}
```

---

### 2. Add git alias to `src/install_env.sh`

Add under the existing `## set git aliases` section:

```sh
git config --global alias.tree '!bash -c "source ~/.bash_aliases && git_alias_tree \"\$@\"" --'
```

---

## File Changes Summary

| File | Change |
|------|--------|
| `src/bash_aliases.sh` | Add `git_alias_tree`, `_git_tree_get`, `_git_tree_set`, `_git_tree_del`, and helper functions |
| `src/install_env.sh` | Add `git config --global alias.tree ...` under git aliases section |

---

## Usage Examples

```sh
# show help
git tree --help
git tree set --help

# list worktrees for current repo
git tree get

# create worktree for branch (from HEAD)
git tree set vlad/new-feature

# create worktree from origin/main
git tree set vlad/new-feature --main

# create and open in codium
git tree set vlad/new-feature --open

# remove worktree
git tree del vlad/new-feature
```

---

## Notes

- Worktrees stored at `../_worktrees/` relative to git root (sibling to repo)
- Branch slashes converted to dots: `vlad/foo` -> `vlad.foo`
- Directory format: `$reponame.$sanitized_branch` (e.g., `rhachet.vlad.new-feature`)
- Idempotent: running `set` twice keeps existing worktree
- Works from main repo or from within a worktree
